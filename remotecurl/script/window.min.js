function check_url(e){let t="";for(let r of $allow_url)!1!==r.test(e)&&(t=e);for(let r of $allow_url)!1!==r.test(e)&&(t="");return""!==t}function get_requested_url(e,t){if(void 0===e)return"";if(null===e)return null;if(e=e.toString(),"#"===e)return e;let r=[$base_main_url,$base_worker_url,$server_url,$main_path,$worker_path];for(let n of r)if(e.startsWith(n))try{let r=e.substring(n.length),o=new URL($url),i=new URL(r,o.origin);if(check_url(i.href))return t+i.href}catch(e){continue}let n=new URL(e,$url).href;return check_url(n)?t+n:e}function get_main_requested_url(e){return get_requested_url(e,$main_path)}function get_worker_requested_url(e){return get_requested_url(e,$worker_path)}function redirect_log(e,t,r){t!==r&&console.debug(e+": Redirect "+t+" to "+r)}function DOMMapping(e,t,r,n){this.target=e,this.css_selector=t,this.attr=r,this.func=n}function overwrite_history(e){let t=e.History.prototype.pushState;e.History.prototype.pushState=function(e,r,n){let o=get_main_requested_url(n);redirect_log("History.pushState",n,o),t.call(this,e,r,o)};let r=e.History.prototype.replaceState;e.History.prototype.replaceState=function(e,t,n){let o=get_main_requested_url(n);redirect_log("History.replaceState",n,o),r.call(this,e,t,o)}}let _open=window.XMLHttpRequest.prototype.open;window.XMLHttpRequest.prototype.open=function(e,t,r){let n=get_main_requested_url(t);redirect_log("XMLHttpRequest",t,n),_open.call(this,e,n,r)};let _fetch=window.fetch;window.fetch=function(e,t){let r=e;return"string"==typeof e?(r=get_main_requested_url(e),redirect_log("Fetch",e,r)):redirect_log("Fetch","<Request Object>","<new Request Object>"),_fetch.call(this,r,t).then(function(e){return e})},window.Request=new Proxy(window.Request,{construct(e,t){let r=get_main_requested_url(t[0]);return redirect_log("Request",t[0],r),t[0]=r,new e(...t)}});let _sendBeacon=window.Navigator.prototype.sendBeacon;if(window.Navigator.prototype.sendBeacon=function(e,t=null){let r=get_main_requested_url(e);return redirect_log("navigator.sendBeacon",e,r),_sendBeacon.call(this,r,t)},window.ServiceWorkerContainer){let e=window.ServiceWorkerContainer.prototype.register;window.ServiceWorkerContainer.prototype.register=function(t,r){let n=get_worker_requested_url(t);redirect_log("ServiceWorkerContainer.register",t,n);let o="/";"object"==typeof r?"scope"in r&&(opt_scope=r.scope):(r={scope:o},opt_scope=r);let i=get_main_requested_url(opt_scope);return r.scope=i,e.call(this,n,r).then(function(e){return e})}}window.Worker=new Proxy(window.Worker,{construct(e,t){let r=get_worker_requested_url(t[0]);return redirect_log("Worker",t[0],r),t[0]=r,new e(...t)}}),window.SharedWorker=new Proxy(window.SharedWorker,{construct(e,t){let r=get_worker_requested_url(t[0]);return redirect_log("SharedWorker",t[0],r),t[0]=r,new e(...t)}});const set_link=function(e,t){let r=get_main_requested_url(t);return redirect_log(e,t,r),r},set_srcset=function(e,t){let r=function(t,r,n,o){if(t.endsWith("x")&&/^\d+$/.test(parseInt(t.substring(0,t.length-1))))return t;{let r=get_main_requested_url(t);return redirect_log(e,t,r),r}},n=t.replace(/(data:image\/[^\s,]+,[^\s,]*|[^,\s]+)/gi,r);return n},set_style=function(e,t){let r=function(e){let t="",r="";return(e.startsWith('"')||e.startsWith("'"))&&(t=e.substring(0,1),e=e.substring(1)),(e.endsWith('"')||e.endsWith("'"))&&(r=e.substring(e.length-1,e.length),e=e.substring(0,e.length-1)),[e,t,r]},n=function(t,n,o,i){let s=r(n),l=get_main_requested_url(s[0]);return redirect_log(e,s[0],l),"url("+s[1]+l+s[2]+")"},o=t.replace(/url\(([^)]+)\)/gi,n);return o},dom_mappings=[new DOMMapping(window.HTMLImageElement,"img[src]","src",set_link),new DOMMapping(window.HTMLImageElement,"img[srcset]","srcset",set_srcset),new DOMMapping(window.HTMLScriptElement,"script[src]","src",set_link),new DOMMapping(window.HTMLEmbedElement,"embed[src]","src",set_link),new DOMMapping(window.HTMLMediaElement,"audio[src], video[src]","src",set_link),new DOMMapping(window.HTMLSourceElement,"source[src]","src",set_link),new DOMMapping(window.HTMLSourceElement,"source[srcset]","srcset",set_srcset),new DOMMapping(window.HTMLTrackElement,"track[src]","src",set_link),new DOMMapping(window.HTMLIFrameElement,"iframe[src]","src",set_link),new DOMMapping(window.HTMLLinkElement,"link[href]","href",set_link),new DOMMapping(window.HTMLAnchorElement,"a[href]","href",set_link),new DOMMapping(window.HTMLAreaElement,"area[href]","href",set_link),new DOMMapping(window.HTMLFormElement,"form[action]","action",set_link)];for(let e of dom_mappings){let t=e.target,r=e.attr,n=e.func;window.Object.defineProperty(t.prototype,r,{enumerable:!0,configurable:!0,get:function(){return this.getAttribute(r)},set:function(e){let o=this.getAttribute(r),i=n(`${t.name}.${r}`,e);return i!==o?this.setAttribute(r,i):o}})}const observer_callback=function(){for(let e of dom_mappings){let t=e.css_selector,r=e.attr,n=document.querySelectorAll(t);for(let e of n)e[r]=e[r]}},observer=new MutationObserver(observer_callback);observer.observe(document,{childList:!0,subtree:!0}),overwrite_history(window);let _appendChild=HTMLElement.prototype.appendChild;HTMLElement.prototype.appendChild=function(e){if(e instanceof HTMLIFrameElement&&(""===e.src||"about:blank"===e.src)&&document.body.contains(this))return _appendChild.call(this,e),overwrite_history(e.contentWindow),e;if(!(this instanceof HTMLStyleElement&&e instanceof Text))return _appendChild.call(this,e);{let t=set_style("HTMLStyleElement.innerText",e.textContent),r=document.createTextNode(t);_appendChild.call(this,r)}};let _append=HTMLElement.prototype.append;HTMLElement.prototype.append=function(...e){for(let t of e)t instanceof HTMLElement?this.appendChild(t):_append.call(this,t)};